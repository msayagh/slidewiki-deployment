version: '2'

volumes:

  mongo-data: {}
  solr-data: {}
  files: {}
  certs: {}

services:

  logger:
    image: slidewiki/logger
    restart: always
    volumes:
      - /data/maintenance/log:/fluentd/log
    ports:
      - "24224:24224"
    networks:
      - front-trier
      - back-trier
    privileged: true

  mongodb:
    restart: always
    volumes:
      - mongo-data:/data/db
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.mongodb"

  solr:
    restart: always
    volumes:
      - solr-data:/solr-data
    environment:
      - VIRTUAL_HOST=solr.testing.slidewiki.org
      - VIRTUAL_PORT=8983
      - LETSENCRYPT_HOST=solr.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.solr"

  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - certs:/etc/nginx/certs:rw
    volumes_from:
      - webserver

  webserver:
    restart: always
    environment:
      - BASENAME=testing.slidewiki.org
    volumes:
      - certs:/etc/nginx/certs:ro
      - /etc/nginx/vhost.d
      - /usr/share/nginx/html
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.webserver"

  platform:
    build: /opt/slidewiki/slidewiki-platform
    restart: always
    environment:
      - VIRTUAL_HOST=testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_DISCUSSION=https://discussionservice.testing.slidewiki.org
      - SERVICE_URL_ACTIVITIES=https://activitiesservice.testing.slidewiki.org
      - SERVICE_URL_NOTIFICATION=https://notificationservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - SERVICE_URL_IMPORT=https://importservice.testing.slidewiki.org
      - SERVICE_URL_FILE=https://fileservice.testing.slidewiki.org
      - SERVICE_URL_IMAGE=https://imageservice.stable.slidewiki.org
      - SERVICE_URL_SEARCH=https://searchservice.testing.slidewiki.org
      - SERVICE_URL_PDF=https://pdfservice.testing.slidewiki.org
      - SERVICE_URL_TAG=https://tagservice.testing.slidewiki.org
      - SERVICE_VAR_IMPORT_HOST=importservice.testing.slidewiki.org
      - SERVICE_PROTOCOL_IMPORT=https
      - SERVICE_PORT_IMPORT=443
      - LETSENCRYPT_HOST=testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
      - SERVICE_USER_PRIVATE_RECAPTCHA_KEY=PRIVATE_KEY
      - SERVICE_USER_PUBLIC_RECAPTCHA_KEY=PUBLIC_KEY
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.platform"

  deckservice:
    build: /opt/slidewiki/deck-service
    restart: always
    environment:
      - VIRTUAL_HOST=deckservice.testing.slidewiki.org
      - SERVICE_URL_FILE=https://fileservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=deckservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.deckservice"

  unoconvservice:
    restart: always
    environment:
      - VIRTUAL_PORT=3000
      - VIRTUAL_HOST=unoconvservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=unoconvservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
      - PAYLOAD_MAX_SIZE=314572800
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.unoconv"

  activitiesservice:
    build: /opt/slidewiki/activities-service
    restart: always
    environment:
      - VIRTUAL_HOST=activitiesservice.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=activitiesservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.activitiesservice"

  discussionservice:
    build: /opt/slidewiki/discussion-service
    restart: always
    environment:
      - VIRTUAL_HOST=discussionservice.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_ACTIVITIES=https://activitiesservice.testing.slidewiki.org
      - SERVICE_URL_NOTIFICATION=https://notificationservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=discussionservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.discussionservice"

  notificationservice:
    build: /opt/slidewiki/notification-service
    restart: always
    environment:
      - VIRTUAL_HOST=notificationservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=notificationservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.notificationservice"

  importservice:
    build: /opt/slidewiki/import-service
    restart: always
    environment:
      - VIRTUAL_HOST=importservice.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_FILE=https://fileservice.testing.slidewiki.org
      - SERVICE_HOST_UNOCONV=unoconvservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=importservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    volumes:
      - files:/data/files
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.importservice"

  userservice:
    build: /opt/slidewiki/user-service
    restart: always
    environment:
      - VIRTUAL_HOST=userservice.testing.slidewiki.org
      - URL_PLATFORM=https://testing.slidewiki.org
      - SERVICE_URL_ACTIVITIES=https://activitiesservice.testing.slidewiki.org
      - SMTP_PORT=25
      - SMTP_HOST=localhost
  #    - SMTP_FROM=me@hostername.org
  #    - SMTP_CLIENTNAME=
  #    - APIKey=
      - JWT_SERIAL=69aac7f95a9152cd4ae7667c80557c284e413d748cca4c5715b3f02020a5ae1b
      - LETSENCRYPT_HOST=userservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    volumes:
      - /data/userservice/providerConfig.json:/nodeApp/config.json
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.userservice"

  pdfservice:
    build: /opt/slidewiki/PDF-Service
    restart: always
    environment:
      - VIRTUAL_HOST=pdfservice.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_PDF=https://pdfservice.testing.slidewiki.org
      - SERVICE_URL_PLATFORM=https://testing.slidewiki.org
      - LETSENCRYPT_HOST=pdfservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.pdfservice"

  fileservice:
    build: /opt/slidewiki/file-service
    restart: always
    environment:
      - VIRTUAL_HOST=fileservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=fileservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    volumes:
      - files:/data/files
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.fileservice"

  searchservice:
    build: /opt/slidewiki/search-service
    restart: always
    environment:
      - VIRTUAL_HOST=searchservice.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=searchservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.searchservice"

  #xapi:
  #  restart: always
  #  environment:
  #    - VIRTUAL_HOST=xapiservice.testing.slidewiki.org
  #    - LETSENCRYPT_HOST=xapiservice.testing.slidewiki.org
  #    - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
  #    - LETSENCRYPT_TEST=true
  #  depends_on:
  #    - logger
  #  logging:
  #    driver: fluentd
  #    options:
  #      fluentd-address: "localhost:24224"
  #      tag: "slidewiki.xapi"

  tagservice:
    build: /opt/slidewiki/tag-service
    restart: always
    environment:
      - VIRTUAL_HOST=tagservice.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_DISCUSSION=https://discussionservice.testing.slidewiki.org
      - SERVICE_URL_ACTIVITIES=https://activitiesservice.testing.slidewiki.org
      - SERVICE_URL_NOTIFICATION=https://notificationservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - SERVICE_URL_SEARCH=https://searchservice.testing.slidewiki.org
      - SERVICE_URL_IMAGE=https://imageservice.testing.slidewiki.org
      - SERVICE_URL_FILE=https://fileservice.testing.slidewiki.org
      - SERVICE_URL_PDF=https://pdfservice.testing.slidewiki.org
      - SERVICE_URL_IMPORT=https://importservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=tagservice.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.tagservice"

  nlpstore:
    build: /opt/slidewiki/nlp-store-service
    restart: always
    environment:
      - VIRTUAL_HOST=nlpstore.testing.slidewiki.org
      - SERVICE_URL_DECK=https://deckservice.testing.slidewiki.org
      - SERVICE_URL_DISCUSSION=https://discussionservice.testing.slidewiki.org
      - SERVICE_URL_ACTIVITIES=https://activitiesservice.testing.slidewiki.org
      - SERVICE_URL_NOTIFICATION=https://notificationservice.testing.slidewiki.org
      - SERVICE_URL_USER=https://userservice.testing.slidewiki.org
      - SERVICE_URL_SEARCH=https://searchservice.testing.slidewiki.org
      - SERVICE_URL_IMAGE=https://imageservice.testing.slidewiki.org
      - SERVICE_URL_FILE=https://fileservice.testing.slidewiki.org
      - SERVICE_URL_PDF=https://pdfservice.testing.slidewiki.org
      - SERVICE_URL_IMPORT=https://importservice.testing.slidewiki.org
      - LETSENCRYPT_HOST=nlpstore.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
    depends_on:
      - logger
    logging:
      driver: fluentd
      options:
        fluentd-address: "localhost:24224"
        tag: "slidewiki.nlpstore"

  maintenance:
    build: ../../maintenance/
    restart: always
    expose:
      - "80"
    environment:
      - VIRTUAL_HOST=maintenance.testing.slidewiki.org
      - LETSENCRYPT_HOST=maintenance.testing.slidewiki.org
      - LETSENCRYPT_EMAIL=pbaptist@uni-bonn.de
#      - LETSENCRYPT_TEST=true
    networks:
      - front-trier
      - back-trier
    volumes:
      - /data/maintenance:/maintenance
      - files:/data/files # used to backup files
    depends_on:
      - mongodb
      - logger
